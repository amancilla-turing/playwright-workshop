name: Playwright Tests

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: lts/*

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Run Playwright tests (JUnit)
        env:
          PLAYWRIGHT_JUNIT_OUTPUT_NAME: results.xml
        run: npx playwright test contact.spec.ts --reporter=junit,html

      - name: Send JUnit to qTest Pulse
        if: ${{ !cancelled() }}
        env:
          PULSE_WEBHOOK_URL: ${{ secrets.PULSE_WEBHOOK_URL }}
          PULSE_SHARED_SECRET: ${{ secrets.PULSE_SHARED_SECRET }}
          QTEST_PROJECT_ID: ${{ secrets.QTEST_PROJECT_ID }}
          QTEST_TEST_CYCLE_ID: ${{ secrets.QTEST_TEST_CYCLE_ID }}
        run: |
          set -e

          echo "Checking results.xml exists..."
          ls -la
          test -f results.xml

          RESULT_B64=$(base64 -w 0 results.xml)

          echo "Posting to Pulse..."
          http_code=$(curl -sS -o /tmp/pulse_response.json -w "%{http_code}" \
            -X POST "$PULSE_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "{
              \"projectId\": \"$QTEST_PROJECT_ID\",
              \"testcycle\": \"$QTEST_TEST_CYCLE_ID\",
              \"result\": \"$RESULT_B64\",
              \"secret\": \"$PULSE_SHARED_SECRET\"
            }")

          echo "Pulse HTTP status: $http_code"
          echo "Pulse response:"
          cat /tmp/pulse_response.json || true

          # Fail the job if Pulse didn't accept it
          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "Pulse call failed"
            exit 1
          fi

      - name: Upload Playwright HTML report artifact
        if: ${{ !cancelled() }}
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30